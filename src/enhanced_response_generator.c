#include "chatbot.h"
#include "database.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

// Multi-language response templates
typedef struct {
    IntentType intent;
    char* english_template;
    char* hindi_template;
    char* regional_template;
    bool needs_location;
    bool needs_data;
    char* follow_up_suggestions[5];
    int suggestion_count;
} MultilingualResponseTemplate;

// Comprehensive response templates
MultilingualResponseTemplate enhanced_templates[] = {
    {
        .intent = INTENT_GREETING,
        .english_template = "üåä Namaste! Welcome to INGRES - India's Groundwater Resource Expert System!\n\n"
                           "I'm your AI assistant for comprehensive groundwater information across India. "
                           "I can help you with:\n\n"
                           "üìä **Real-time Data**: Current groundwater status for any location\n"
                           "üìà **Trend Analysis**: Historical patterns and future predictions\n"
                           "‚ö†Ô∏è **Crisis Alerts**: Critical and over-exploited areas\n"
                           "üîÑ **Comparisons**: Multi-location and temporal analysis\n"
                           "üèõÔ∏è **Policy Insights**: Government schemes and recommendations\n"
                           "üå± **Conservation**: Sustainable water management strategies\n\n"
                           "Try asking: 'Show groundwater crisis in Punjab' or 'Compare water trends in Gujarat vs Rajasthan'",
        .hindi_template = "üåä ‡§®‡§Æ‡§∏‡•ç‡§§‡•á! INGRES ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à - ‡§≠‡§æ‡§∞‡§§ ‡§ï‡•Ä ‡§≠‡•Ç‡§ú‡§≤ ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§® ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä!\n\n"
                         "‡§Æ‡•à‡§Ç ‡§≠‡§æ‡§∞‡§§ ‡§≠‡§∞ ‡§Æ‡•á‡§Ç ‡§µ‡•ç‡§Ø‡§æ‡§™‡§ï ‡§≠‡•Ç‡§ú‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§™‡§ï‡§æ AI ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§π‡•Ç‡§Ç‡•§",
        .needs_location = false,
        .needs_data = false,
        .follow_up_suggestions = {
            "Show me critical groundwater areas",
            "Compare Punjab vs Haryana water status", 
            "What are the conservation methods?",
            "Explain groundwater categories",
            "Show rainfall impact on groundwater"
        },
        .suggestion_count = 5
    },
    
    {
        .intent = INTENT_QUERY_LOCATION,
        .english_template = "üîç **GROUNDWATER ANALYSIS FOR %s**\n\n"
                           "üìç **Location**: %s\n"
                           "üìÖ **Assessment Year**: %d\n"
                           "üè∑Ô∏è **Category**: %s\n"
                           "üíß **Annual Recharge**: %.2f MCM\n"
                           "üè≠ **Annual Extraction**: %.2f MCM\n"
                           "üìä **Stage of Extraction**: %.1f%%\n"
                           "‚öñÔ∏è **Net Availability**: %.2f MCM\n\n"
                           "**Status Interpretation**:\n%s\n\n"
                           "**Trend**: %s over the past 3 years\n"
                           "**Risk Level**: %s",
        .needs_location = true,
        .needs_data = true,
        .follow_up_suggestions = {
            "Show historical trend for this area",
            "Compare with neighboring regions",
            "What conservation methods are suitable?",
            "Show policy recommendations",
            "Explain the technical details"
        },
        .suggestion_count = 5
    },
    
    {
        .intent = INTENT_CRITICAL_AREAS,
        .english_template = "üö® **CRITICAL GROUNDWATER AREAS - URGENT ATTENTION REQUIRED**\n\n"
                           "**OVER-EXPLOITED REGIONS** (>100%% extraction):\n"
                           "üî¥ **Punjab**: 78%% of blocks affected\n"
                           "   ‚Ä¢ Amritsar: 165%% extraction rate\n"
                           "   ‚Ä¢ Ludhiana: 178%% extraction rate\n"
                           "   ‚Ä¢ Bathinda: 156%% extraction rate\n\n"
                           "üî¥ **Haryana**: 45%% of blocks affected\n"
                           "   ‚Ä¢ Sirsa: 189%% extraction rate\n"
                           "   ‚Ä¢ Hisar: 145%% extraction rate\n\n"
                           "üî¥ **Tamil Nadu**: Urban stress zones\n"
                           "   ‚Ä¢ Chennai: 167%% extraction rate\n\n"
                           "**CRITICAL REGIONS** (90-100%% extraction):\n"
                           "üü† **Maharashtra**: Pune (156%%), Aurangabad (145%%)\n"
                           "üü† **Karnataka**: Bangalore Urban (167%%)\n"
                           "üü† **Gujarat**: Ahmedabad City (156%%)\n"
                           "üü† **Rajasthan**: Alwar (134%%)\n\n"
                           "**IMMEDIATE ACTIONS NEEDED**:\n"
                           "‚Ä¢ Strict groundwater extraction regulations\n"
                           "‚Ä¢ Mandatory rainwater harvesting\n"
                           "‚Ä¢ Crop pattern diversification\n"
                           "‚Ä¢ Industrial water recycling",
        .needs_location = false,
        .needs_data = true,
        .follow_up_suggestions = {
            "Show conservation methods for critical areas",
            "Policy recommendations for over-exploited regions",
            "Compare with safe areas",
            "Historical trend of critical areas",
            "Economic impact of groundwater crisis"
        },
        .suggestion_count = 5
    },
    
    {
        .intent = INTENT_COMPARE_LOCATIONS,
        .english_template = "üîÑ **COMPARATIVE GROUNDWATER ANALYSIS**\n\n"
                           "**%s vs %s** (Latest Assessment)\n\n"
                           "| Parameter | %s | %s |\n"
                           "|-----------|---------|----------|\n"
                           "| Over-exploited blocks | %d%% | %d%% |\n"
                           "| Average extraction | %.1f%% | %.1f%% |\n"
                           "| Water table trend | %s | %s |\n"
                           "| Primary concern | %s | %s |\n"
                           "| Risk level | %s | %s |\n\n"
                           "**KEY INSIGHTS**:\n"
                           "‚Ä¢ %s shows %s groundwater stress\n"
                           "‚Ä¢ %s has %s management practices\n"
                           "‚Ä¢ Both regions need %s\n\n"
                           "**RECOMMENDATIONS**:\n"
                           "‚Ä¢ %s: Focus on %s\n"
                           "‚Ä¢ %s: Implement %s",
        .needs_location = true,
        .needs_data = true,
        .follow_up_suggestions = {
            "Show detailed data for each location",
            "Historical comparison over 5 years",
            "Policy differences between regions",
            "Success stories from better performing area",
            "Joint conservation strategies"
        },
        .suggestion_count = 5
    },
    
    {
        .intent = INTENT_HISTORICAL_TREND,
        .english_template = "üìà **HISTORICAL GROUNDWATER TREND ANALYSIS**\n\n"
                           "üìç **Location**: %s\n"
                           "üìÖ **Analysis Period**: 2019-2023 (5 years)\n\n"
                           "**YEAR-WISE EXTRACTION TRENDS**:\n"
                           "‚Ä¢ 2019: %.1f%% extraction\n"
                           "‚Ä¢ 2020: %.1f%% extraction (%+.1f%%)\n"
                           "‚Ä¢ 2021: %.1f%% extraction (%+.1f%%)\n"
                           "‚Ä¢ 2022: %.1f%% extraction (%+.1f%%)\n"
                           "‚Ä¢ 2023: %.1f%% extraction (%+.1f%%)\n\n"
                           "**TREND ANALYSIS**:\n"
                           "üìä **Overall Trend**: %s\n"
                           "üìâ **Annual Change Rate**: %+.2f%% per year\n"
                           "üéØ **Category Change**: %s ‚Üí %s\n"
                           "‚ö†Ô∏è **Risk Trajectory**: %s\n\n"
                           "**CONTRIBUTING FACTORS**:\n"
                           "‚Ä¢ Rainfall variation: %s\n"
                           "‚Ä¢ Agricultural practices: %s\n"
                           "‚Ä¢ Industrial growth: %s\n"
                           "‚Ä¢ Policy interventions: %s\n\n"
                           "**FUTURE PROJECTION** (2024-2026):\n"
                           "If current trend continues: %s",
        .needs_location = true,
        .needs_data = true,
        .follow_up_suggestions = {
            "Show rainfall correlation analysis",
            "Compare with national average trend",
            "Policy interventions needed",
            "Success stories from similar regions",
            "Detailed monthly breakdown"
        },
        .suggestion_count = 5
    },
    
    {
        .intent = INTENT_POLICY_SUGGESTION,
        .english_template = "üèõÔ∏è **COMPREHENSIVE POLICY RECOMMENDATIONS FOR %s**\n\n"
                           "**IMMEDIATE MEASURES** (0-6 months):\n"
                           "üö® **Regulatory Actions**:\n"
                           "‚Ä¢ Implement groundwater extraction permits\n"
                           "‚Ä¢ Mandatory water audits for industries\n"
                           "‚Ä¢ Ban on new bore wells in over-exploited areas\n"
                           "‚Ä¢ Real-time monitoring system installation\n\n"
                           "üíß **Conservation Mandates**:\n"
                           "‚Ä¢ Rainwater harvesting for buildings >300 sq.m\n"
                           "‚Ä¢ Drip irrigation subsidies (50%% cost)\n"
                           "‚Ä¢ Greywater recycling in urban areas\n\n"
                           "**MEDIUM-TERM STRATEGIES** (6 months - 2 years):\n"
                           "üåæ **Agricultural Reforms**:\n"
                           "‚Ä¢ Crop diversification incentives\n"
                           "‚Ä¢ Shift from water-intensive crops (rice/sugarcane)\n"
                           "‚Ä¢ Promote drought-resistant varieties\n"
                           "‚Ä¢ Micro-irrigation expansion\n\n"
                           "üè≠ **Industrial Measures**:\n"
                           "‚Ä¢ Water recycling mandates (80%% reuse)\n"
                           "‚Ä¢ Effluent treatment plant upgrades\n"
                           "‚Ä¢ Water-positive industrial policies\n\n"
                           "**LONG-TERM VISION** (2-5 years):\n"
                           "üåç **Sustainable Management**:\n"
                           "‚Ä¢ Aquifer mapping and protection\n"
                           "‚Ä¢ Inter-basin water transfer projects\n"
                           "‚Ä¢ Community-based water management\n"
                           "‚Ä¢ Climate-resilient water infrastructure\n\n"
                           "**FINANCIAL FRAMEWORK**:\n"
                           "üí∞ **Investment Required**: ‚Çπ%d crores\n"
                           "üìä **Expected Impact**: %d%% reduction in extraction\n"
                           "‚è±Ô∏è **Timeline**: %d years for full implementation",
        .needs_location = true,
        .needs_data = false,
        .follow_up_suggestions = {
            "Show successful policy examples",
            "Economic analysis of recommendations",
            "Implementation timeline details",
            "Stakeholder engagement strategy",
            "Monitoring and evaluation framework"
        },
        .suggestion_count = 5
    },
    
    {
        .intent = INTENT_CONSERVATION_METHODS,
        .english_template = "üå± **COMPREHENSIVE WATER CONSERVATION STRATEGIES**\n\n"
                           "**RAINWATER HARVESTING**:\n"
                           "üè† **Rooftop Systems**:\n"
                           "‚Ä¢ Potential: 1-2 lakh liters/year per household\n"
                           "‚Ä¢ Cost: ‚Çπ15,000-50,000 (one-time)\n"
                           "‚Ä¢ Payback: 3-5 years\n"
                           "‚Ä¢ Suitable for: Urban and semi-urban areas\n\n"
                           "üèûÔ∏è **Community Systems**:\n"
                           "‚Ä¢ Check dams and percolation tanks\n"
                           "‚Ä¢ Recharge wells and injection wells\n"
                           "‚Ä¢ Watershed management\n\n"
                           "**AGRICULTURAL EFFICIENCY**:\n"
                           "üíß **Micro-irrigation**:\n"
                           "‚Ä¢ Drip irrigation: 30-50%% water savings\n"
                           "‚Ä¢ Sprinkler systems: 20-40%% savings\n"
                           "‚Ä¢ Fertigation: Nutrient + water efficiency\n\n"
                           "üåæ **Crop Management**:\n"
                           "‚Ä¢ Drought-resistant varieties\n"
                           "‚Ä¢ Crop rotation and intercropping\n"
                           "‚Ä¢ Mulching and soil moisture conservation\n"
                           "‚Ä¢ Precision agriculture techniques\n\n"
                           "**INDUSTRIAL CONSERVATION**:\n"
                           "‚ôªÔ∏è **Water Recycling**:\n"
                           "‚Ä¢ Closed-loop systems: 80-90%% reuse\n"
                           "‚Ä¢ Membrane technologies\n"
                           "‚Ä¢ Zero liquid discharge (ZLD)\n\n"
                           "**URBAN STRATEGIES**:\n"
                           "üèôÔ∏è **Smart Water Management**:\n"
                           "‚Ä¢ Leak detection systems\n"
                           "‚Ä¢ Smart meters and monitoring\n"
                           "‚Ä¢ Greywater recycling\n"
                           "‚Ä¢ Permeable pavements\n\n"
                           "**NATURAL SOLUTIONS**:\n"
                           "üå≥ **Ecosystem-based Approaches**:\n"
                           "‚Ä¢ Wetland restoration\n"
                           "‚Ä¢ Forest conservation\n"
                           "‚Ä¢ Soil health improvement\n"
                           "‚Ä¢ Biodiversity conservation",
        .needs_location = false,
        .needs_data = false,
        .follow_up_suggestions = {
            "Cost-benefit analysis of methods",
            "Location-specific recommendations",
            "Government schemes and subsidies",
            "Success stories and case studies",
            "Technical implementation guides"
        },
        .suggestion_count = 5
    },
    
    {
        .intent = INTENT_RAINFALL_CORRELATION,
        .english_template = "üåßÔ∏è **RAINFALL-GROUNDWATER CORRELATION ANALYSIS**\n\n"
                           "**MONSOON IMPACT ON GROUNDWATER RECHARGE**:\n\n"
                           "üìä **Recharge Efficiency by Region**:\n"
                           "‚Ä¢ Western Ghats: 60-80%% (High permeability)\n"
                           "‚Ä¢ Gangetic Plains: 40-60%% (Moderate permeability)\n"
                           "‚Ä¢ Deccan Plateau: 30-50%% (Variable geology)\n"
                           "‚Ä¢ Arid Regions: 10-30%% (Low permeability)\n\n"
                           "**SEASONAL PATTERNS**:\n"
                           "üå¶Ô∏è **Southwest Monsoon** (June-September):\n"
                           "‚Ä¢ Contributes 70-80%% of annual recharge\n"
                           "‚Ä¢ Peak recharge: July-August\n"
                           "‚Ä¢ Regional variation: 500-3000mm rainfall\n\n"
                           "üå®Ô∏è **Northeast Monsoon** (October-December):\n"
                           "‚Ä¢ Contributes 15-20%% of annual recharge\n"
                           "‚Ä¢ Critical for Tamil Nadu and Andhra Pradesh\n"
                           "‚Ä¢ Coastal areas benefit most\n\n"
                           "**RAINFALL-RECHARGE RELATIONSHIPS**:\n"
                           "üìà **Good Monsoon** (>110%% of normal):\n"
                           "‚Ä¢ Groundwater recharge: +15 to +25%%\n"
                           "‚Ä¢ Water table rise: 1-3 meters\n"
                           "‚Ä¢ Category improvement possible\n\n"
                           "üìâ **Poor Monsoon** (<90%% of normal):\n"
                           "‚Ä¢ Groundwater recharge: -20 to -40%%\n"
                           "‚Ä¢ Water table decline: 0.5-2 meters\n"
                           "‚Ä¢ Increased extraction stress\n\n"
                           "**CLIMATE CHANGE IMPACTS**:\n"
                           "üå°Ô∏è **Changing Patterns**:\n"
                           "‚Ä¢ Increased rainfall variability\n"
                           "‚Ä¢ More intense but shorter duration rains\n"
                           "‚Ä¢ Delayed monsoon onset\n"
                           "‚Ä¢ Increased extreme weather events\n\n"
                           "**ADAPTATION STRATEGIES**:\n"
                           "‚Ä¢ Enhanced rainwater harvesting\n"
                           "‚Ä¢ Improved forecasting systems\n"
                           "‚Ä¢ Flexible cropping patterns\n"
                           "‚Ä¢ Climate-resilient infrastructure",
        .needs_location = false,
        .needs_data = false,
        .follow_up_suggestions = {
            "Show regional rainfall patterns",
            "Climate change projections",
            "Adaptation strategies for farmers",
            "Monsoon forecasting accuracy",
            "Correlation with specific locations"
        },
        .suggestion_count = 5
    },
    
    {
        .intent = INTENT_TECHNICAL_EXPLANATION,
        .english_template = "üî¨ **TECHNICAL GROUNDWATER CONCEPTS EXPLAINED**\n\n"
                           "**STAGE OF GROUNDWATER EXTRACTION**:\n"
                           "üìä **Formula**: (Annual Extraction / Net Annual Availability) √ó 100\n\n"
                           "**CATEGORY DEFINITIONS**:\n"
                           "üü¢ **SAFE** (<70%% extraction):\n"
                           "‚Ä¢ Sustainable extraction levels\n"
                           "‚Ä¢ No restrictions on development\n"
                           "‚Ä¢ Water table stable or rising\n"
                           "‚Ä¢ Example: Jaipur (65%%), Kolkata (56%%)\n\n"
                           "üü° **SEMI-CRITICAL** (70-90%% extraction):\n"
                           "‚Ä¢ Moderate stress on aquifer\n"
                           "‚Ä¢ Careful development needed\n"
                           "‚Ä¢ Monitoring required\n"
                           "‚Ä¢ Example: Nashik (89%%), Coimbatore (98%%)\n\n"
                           "üü† **CRITICAL** (90-100%% extraction):\n"
                           "‚Ä¢ High stress on groundwater\n"
                           "‚Ä¢ Immediate intervention needed\n"
                           "‚Ä¢ Regulated development\n"
                           "‚Ä¢ Example: Pune (156%%), Bangalore (167%%)\n\n"
                           "üî¥ **OVER-EXPLOITED** (>100%% extraction):\n"
                           "‚Ä¢ Groundwater mining occurring\n"
                           "‚Ä¢ Ban on new extractions\n"
                           "‚Ä¢ Urgent conservation needed\n"
                           "‚Ä¢ Example: Amritsar (165%%), Ludhiana (178%%)\n\n"
                           "**KEY PARAMETERS EXPLAINED**:\n\n"
                           "üíß **Annual Recharge**:\n"
                           "‚Ä¢ Natural replenishment from rainfall\n"
                           "‚Ä¢ Return flow from irrigation\n"
                           "‚Ä¢ Artificial recharge contributions\n"
                           "‚Ä¢ Measured in Million Cubic Meters (MCM)\n\n"
                           "üè≠ **Annual Extraction**:\n"
                           "‚Ä¢ Agricultural use (85-90%%)\n"
                           "‚Ä¢ Domestic use (5-10%%)\n"
                           "‚Ä¢ Industrial use (2-5%%)\n"
                           "‚Ä¢ Measured through surveys and estimates\n\n"
                           "‚öñÔ∏è **Net Annual Availability**:\n"
                           "‚Ä¢ Total recharge minus natural discharge\n"
                           "‚Ä¢ Allocation for ecological needs\n"
                           "‚Ä¢ Available for human use\n\n"
                           "**ASSESSMENT METHODOLOGY**:\n"
                           "üìã **CGWB Protocol**:\n"
                           "‚Ä¢ Hydrogeological surveys\n"
                           "‚Ä¢ Water level monitoring\n"
                           "‚Ä¢ Pumping test analysis\n"
                           "‚Ä¢ Remote sensing integration\n"
                           "‚Ä¢ Community participation",
        .needs_location = false,
        .needs_data = false,
        .follow_up_suggestions = {
            "Show calculation examples",
            "Explain assessment methodology",
            "Compare international standards",
            "Data collection methods",
            "Quality assurance processes"
        },
        .suggestion_count = 5
    }
};

int enhanced_template_count = sizeof(enhanced_templates) / sizeof(MultilingualResponseTemplate);

// Generate enhanced response with context awareness
BotResponse* generate_enhanced_response(IntentType intent, const char* user_input, 
                                      ConversationContext* context, const char* location, 
                                      const char* query_details) {
    BotResponse* response = malloc(sizeof(BotResponse));
    if (!response) return NULL;
    
    // Initialize response structure
    response->intent = intent;
    response->query_result = NULL;
    response->has_data = false;
    response->processing_time_ms = 0.0;
    response->confidence_score = 0.8;  // Default confidence
    response->suggestion_count = 0;
    response->requires_clarification = false;
    response->clarification_question = NULL;
    response->context = context;
    response->source_count = 0;
    response->is_multilingual = false;
    response->language_code = strdup("en");
    
    // Initialize suggestions array
    for (int i = 0; i < 5; i++) {
        response->suggested_actions[i] = NULL;
    }
    
    // Find matching template
    MultilingualResponseTemplate* template = NULL;
    for (int i = 0; i < enhanced_template_count; i++) {
        if (enhanced_templates[i].intent == intent) {
            template = &enhanced_templates[i];
            break;
        }
    }
    
    if (!template) {
        response->message = strdup("I apologize, but I couldn't generate a proper response for your query. Please try rephrasing or ask for help.");
        return response;
    }
    
    // Copy suggestions
    response->suggestion_count = template->suggestion_count;
    for (int i = 0; i < template->suggestion_count && i < 5; i++) {
        response->suggested_actions[i] = strdup(template->follow_up_suggestions[i]);
    }
    
    // Generate response based on template and data needs
    char* formatted_response = malloc(4096);  // Larger buffer for complex responses
    if (!formatted_response) {
        response->message = strdup("Memory allocation error occurred.");
        return response;
    }
    
    if (template->needs_data && location) {
        // Fetch data and format response with actual data
        // This is a simplified version - in real implementation, 
        // you would query the database here
        snprintf(formatted_response, 4096, template->english_template, 
                location, location, 2023, "Over-Exploited", 156.8, 178.5, 113.8, 89.2,
                "This area shows severe groundwater stress with extraction exceeding sustainable limits.",
                "Declining", "Very High");
    } else if (intent == INTENT_COMPARE_LOCATIONS) {
        // Handle comparison responses
        const char* loc1 = location ? location : "Punjab";
        const char* loc2 = "Haryana";  // Default comparison
        snprintf(formatted_response, 4096, template->english_template,
                loc1, loc2, loc1, loc2, 78, 45, 150.5, 95.2,
                "Declining 2-3m", "Mixed trends", "Rice-wheat cultivation", "Industrial demand",
                "Very High", "High", loc1, "higher", loc2, "better",
                "immediate intervention", loc1, "crop diversification", loc2, "industrial regulation");
    } else {
        // Use template as-is for general responses
        strcpy(formatted_response, template->english_template);
    }
    
    response->message = formatted_response;
    response->has_data = template->needs_data;
    
    // Add data sources
    response->data_sources[0] = strdup("Central Ground Water Board (CGWB)");
    response->data_sources[1] = strdup("National Water Informatics Centre (NWIC)");
    response->data_sources[2] = strdup("State Ground Water Departments");
    response->source_count = 3;
    
    return response;
}

// Enhanced free function for new response structure
void free_enhanced_bot_response(BotResponse* response) {
    if (!response) return;
    
    if (response->message) free(response->message);
    if (response->query_result) free_query_result(response->query_result);
    if (response->clarification_question) free(response->clarification_question);
    if (response->language_code) free(response->language_code);
    
    for (int i = 0; i < response->suggestion_count; i++) {
        if (response->suggested_actions[i]) {
            free(response->suggested_actions[i]);
        }
    }
    
    for (int i = 0; i < response->source_count; i++) {
        if (response->data_sources[i]) {
            free(response->data_sources[i]);
        }
    }
    
    free(response);
}